pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        REGISTRY_URL = "registry.black-crab.cc"
        IMAGE_NAME   = "demo-quarkus"
        FULL_IMAGE   = "${env.REGISTRY_URL}/${env.IMAGE_NAME}:latest"
    }

    stages {
        // Connect to Github repo
        stage('Checkout Source') {
            steps {
                git credentialsId: 'github-creds',
                    url: 'https://github.com/funmicra/java_quarkus_project.git',
                    branch: 'master'
            }
        }

        // Terraform Provision
        stage('Terraform Provision VMs') {
            steps {
                withCredentials([
                    string(credentialsId: 'PROXMOX_TOKEN_ID', variable: 'PM_API_TOKEN_ID'),
                    string(credentialsId: 'PROXMOX_TOKEN_SECRET', variable: 'PM_API_TOKEN_SECRET'),
                    string(credentialsId: 'VM_CI_PASSWORD', variable: 'CI_PASSWORD'),
                    file(credentialsId: 'PROXMOX_SSH_KEY', variable: 'SSH_KEYS_FILE')
                ]) {
                    sh '''
                        cd terraform
                        
                        TF_VAR_pm_api_token_id=$PM_API_TOKEN_ID \
                        TF_VAR_pm_api_token_secret=$PM_API_TOKEN_SECRET \
                        TF_VAR_ciuser=funmicra \
                        TF_VAR_cipassword=$CI_PASSWORD \
                        TF_VAR_ssh_keys_file=$SSH_KEYS_FILE \
                        terraform init

                        TF_VAR_pm_api_token_id=$PM_API_TOKEN_ID \
                        TF_VAR_pm_api_token_secret=$PM_API_TOKEN_SECRET \
                        TF_VAR_ciuser=funmicra \
                        TF_VAR_cipassword=$CI_PASSWORD \
                        TF_VAR_ssh_keys_file=$SSH_KEYS_FILE \
                        terraform apply -auto-approve

                        sleep 20
                    '''
                }
            }
        }

        // Deploy Kubernetes with Kubespray
        stage('Deploy Kubernetes Cluster with Kubespray') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'PROXMOX_SSH_PRIVATE_KEY',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        rm -rf kubespray
                        git clone https://github.com/kubernetes-sigs/kubespray.git
                        cd kubespray

                        python3 -m venv venv
                        source venv/bin/activate
                        python3 -m pip install --upgrade pip

                        pip3 install -r requirements.txt

                        cp -rfp inventory/sample inventory/mycluster
                        
                        CONFIG_FILE=inventory/mycluster/hosts.yaml

                        cat <<EOF > $CONFIG_FILE
all:
  hosts:
    ctrl-plane:
      ansible_host: 192.168.88.90
      ip: 192.168.88.90
      access_ip: 192.168.88.90
    worker1:
      ansible_host: 192.168.88.91
      ip: 192.168.88.91
      access_ip: 192.168.88.91
  children:
    kube_control_plane:
      hosts:
        ctrl-plane:
    kube_node:
      hosts:
        worker1:
    etcd:
      hosts:
        ctrl-plane:
    k8s_cluster:
      children:
        kube_control_plane:
        kube_node:
    calico_rr:
      hosts: {}
EOF

                        ansible-playbook -i inventory/mycluster/hosts.yaml \
                            --private-key $SSH_KEY \
                            -u funmicra \
                            --become --become-user=root \
                            cluster.yml
                    '''
                }
            }
        }

    } // <-- closes stages block

    post {
        success {
            echo "Pipeline executed successfully!"
        }
        failure {
            echo "Pipeline failed. Check logs for errors."
        }
    }
} // <-- closes pipeline block
