# ---
# - name: Provision Docker Runtime on Rocky Linux
#   hosts: rocky_nodes
#   become: true
#   vars:
#     docker_packages:
#       - yum-utils
#       - device-mapper
#       - device-mapper-event
#       - device-mapper-persistent-data
#       - lvm2
#       - python3-pip

#   tasks:
#     - name: Ensure prerequisite packages are present
#       package:
#         name: "{{ docker_packages }}"
#         state: present
#         update_cache: yes
#       register: pkg_install
#       retries: 3
#       delay: 5
#       until: pkg_install is succeeded

#     - name: Install Docker Python SDK
#       pip:
#         name: docker
#         executable: pip3

#     - name: Add Docker official repository
#       command: >
#         yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
#       args:
#         creates: /etc/yum.repos.d/docker-ce.repo

#     - name: Install Docker Engine and companion stack
#       package:
#         name:
#           - docker-ce
#           - docker-ce-cli
#           - containerd.io
#           - docker-buildx-plugin
#           - docker-compose-plugin
#         state: latest

#     - name: Enable and start Docker service
#       systemd:
#         name: docker
#         enabled: true
#         state: started

#     - name: Add user to docker group (optional)
#       user:
#         name: "{{ ansible_user }}"
#         groups: docker
#         append: true

#     - name: Verify Docker installation
#       command: docker --version
#       register: docker_check
#       failed_when: docker_check.rc != 0

---
- name: Provision Docker Runtime on Rocky Linux
  hosts: rocky_nodes
  become: true
  vars:
    docker_packages_core:
      - yum-utils
      - device-mapper
      - device-mapper-event
      - device-mapper-persistent-data
      - lvm2
    docker_packages_extra:
      - python3-pip

  tasks:

    - name: Refresh DNF cache
      shell: dnf clean all && dnf makecache --refresh

    - name: Install core prerequisite packages
      package:
        name: "{{ docker_packages_core }}"
        state: present
        update_cache: yes

    - name: Install extra prerequisite packages
      package:
        name: "{{ docker_packages_extra }}"
        state: present
        update_cache: yes

    - name: Install Docker Python SDK
      pip:
        name: docker
        executable: pip3

    - name: Add Docker official repository
      command: >
        yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine and companion stack
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: latest

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: true
        state: started

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: Verify Docker installation
      command: docker --version
      register: docker_check
      failed_when: docker_check.rc != 0
