---
- name: Fetch Kubernetes admin kubeconfig
  hosts: EuroDyn1
  gather_facts: no
  become: yes
  become_method: sudo
  vars:
    local_kube_dir: "/var/lib/jenkins/.kube"
    remote_kube_file: "/etc/kubernetes/admin.conf"
    server_ip: "192.168.88.90"

  tasks:

    - name: Ensure local .kube directory exists
      local_action:
        module: file
        path: "{{ local_kube_dir }}"
        state: directory
        mode: "0700"
        owner: jenkins
        group: jenkins

    - name: Fetch admin kubeconfig from control-plane
      fetch:
        src: "{{ remote_kube_file }}"
        dest: "{{ local_kube_dir }}/config"
        flat: yes
        fail_on_missing: yes

    - name: Update server IP in kubeconfig
      local_action:
        module: command
        cmd: "sed -i 's|server: https://.*:6443|server: https://{{ server_ip }}:6443|' {{ local_kube_dir }}/config"

    - name: Fix ownership and permissions locally
      local_action:
        module: file
        path: "{{ local_kube_dir }}/config"
        owner: jenkins
        group: jenkins
        mode: "0600"
